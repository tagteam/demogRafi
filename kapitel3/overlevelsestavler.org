* Introduktion

Overlevelsestavlen repræsenterer en matematisk model, der beskriver
forskelige dødelighedsmål ved hjælp af konkrete demografiske
data. Modellen genererer derefter en omfattende beskrivelse af
dødelighedsforholdene i den specifikke befolkning. De forskellige mål
for dødelighed konstrueres på baggrund af overlevelsestavlen.
Lignende metoder bruges til målene vedrørende forekomsten af vielser,
skilsmisser, folkevandringer og i vis grad forskellige fertilitets- og
reproduktionsmål. Overlevelsestavlen kunne derfor gennemgås på en ret
abstrakt måde og fortolkes forskelligt, afhængigt af om den skal
anvendes til at beskrive dødelighed, vielser, skilsmisser eller
fertilitet. I det følgende vil vi dog fokusere på at opbygge modellen
omkring målingen af befolkningens dødelighed for at gøre det lettere
at forstå modellens umiddelbare anvendelighed.

** Middellevetid

Hvor mange år kan en nyfødt i dag forvente at leve? Dette spørgsmål er
umuligt at besvare korrekt, fordi svaret umiddelbart afhænger af, hvad
der sker i fremtiden. Alligevel er middellevetid, altså den forventede
gennemsnitlige levetid af en nyfødt, et demografisk værktøj, som
anvendes hyppigt til belysning af befolkningens nuværende
dødelighedsniveau. Middellevetid bruges også som
sammenligningsgrundlag på tværs af befolkninger og tid. Tallet angiver
det antal år, som en nyfødt kan forvente at leve /under den
forudsætning/, at de nuværende mortalitetsrater for alle grupperinger
af køn og alderstrin holder sig på samme niveau i fremtiden.  Med
middellevetiden har man et relativt simpelt begreb, som gør det muligt
at sammenligne forskellige befolkningers dødelighed. I praksis vil de
nuværende dødshyppigheder formentlig ikke holde sig på samme niveau i
fremtiden, så det skal man tage højde for når man fortolker
middellevetiden.

Igennem mange år har der været en tendens til faldende
mortalitetsrater, og der er meget, som tyder på, at det er en
udvikling som fortsætter. Den konkrete fortolkning af middellevetiden
for 0-årige som det gennemsnitlige antal år, som en nyfødt kan
forventes at leve, vil derfor formentlig undervurdere den faktiske
middellevetid. Men formålet med middellevetiden er heller ikke at
forudsige præcist, hvor længe en nyfødt vil leve. Formålet er at have et
simpelt begreb, der kan sammenlignes på tværs af befolkninger og tid.
Figur ref:fig:k3-middellevetid viser udviklingen af middellevetid for
0-årige i Danmark siden 1840.

#+BEGIN_SRC R :results file graphics :file ./kapitel3/K3-udvikling-middellevetid.pdf :exports none :session *R* :cache yes
m <- hent_data("HISB7",tid = "all",køn = "all")
m <- mutate(m,kalender = as.numeric(sapply(strsplit(TID,":"),"[",1)))
g <- ggplot(m,aes(kalender,INDHOLD,colour = KØN,group = KØN))+geom_line()
g <- g+theme_wsj()+ scale_colour_wsj("colors6") + theme(axis.text.x = element_text(angle = -45))
g <- g+theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
g <- g + theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)))
g <- g+scale_x_continuous(breaks = seq(1840,2023,10))
g + ylab("Middellevetid for 0-årige (år)")+xlab("")
#+END_SRC

#+RESULTS[(2024-03-01 09:48:59) 906f5d7a78cc606c22b3cb67dfb5c43fd4eafa0a]:
[[file:./kapitel3/K3-udvikling-middellevetid.pdf]]

#+name: fig:k3-middellevetid
#+ATTR_LATEX: :width 0.9\textwidth
#+CAPTION: Udviklingen i middellevetid for 0-årige. Kilde: statistikbankens HISB7.
[[file:./K3-udvikling-middellevetid.pdf]]

** Andre dødelighedsmål

Middellevetiden er måske det vigtigste mål, som resulterer af
overlevelsestavlen. En overlevelsestavle beskriver også en række andre
dødelighedsmål, såsom den forventede restlevetid fra alder \(x\),
sandsynligheden for at dø inden alder \(x\) og sandsynligheden for at
være i live ved alder \(x\).
Figur ref:fig:k3-middellevetid viser middelrestlevetiden for
43-årige i Danmark siden 1981.


#+BEGIN_SRC R :results file graphics :file ./kapitel3/K3-udvikling-middelrestlevetid.pdf :exports none :session *R* :cache yes
m <- hent_data("HISB8",alder = 43,tavle = 3,tid = "all",køn = "all")
m <- mutate(m,kalender = as.numeric(sapply(strsplit(TID,":"),"[",1)))
g <- ggplot(m,aes(kalender,INDHOLD,colour = KØN,group = KØN))+geom_line()
g <- g+theme_economist()+ scale_colour_wsj("colors6") + theme(axis.text.x = element_text(angle = -45))
g <- g+theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
g <- g+theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)))
g <- g+scale_x_continuous(breaks = seq(1840,2023,10))
g + ylab("Middelrestlevetid for 43 årige (år)")+xlab("")
#+END_SRC

#+RESULTS[(2024-03-01 09:48:53) c9af3a242ea2c505b0f102edf2b3639b89c1af65]:
[[file:./kapitel3/K3-udvikling-middelrestlevetid.pdf]]

#+name: fig:k3-middelrestlevetid
#+ATTR_LATEX: :width 0.9\textwidth
#+CAPTION: Udviklingen i middelrestlevetid for 43-årige. Kilde: statistikbankens HISB8.
[[file:./K3-udvikling-middelrestlevetid.pdf]]

** Eksempel

Vi henter data fra statistikbankens register =FOLK1a= og =FOD207= og
beregner aldersspecifikke mortalitetsrater for kvinder i Danmark i 2019.
Vi inddeler i 12 aldersintervaller, hvor det første interval har
længde 1 år, det andet interval har længde 9 år, resten af intervallerne
har længde 10 år, og det sidste aldersinterval er fra 90 til 125 år. 

#+ATTR_LATEX: :options otherkeywords={hent_mortalitetsrate_data,filter,mutate,overlevelsestavle}, deletekeywords={c,rep,print,seq,R}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
x <- hent_mortalitetsrate_data(tid = 2019,
                               breaks = c(0,1,10,seq(20,90,10),Inf),
                               køn = "kvinder")
x <- mutate(x,M = Dod/R)
x
#+END_SRC

#+RESULTS[(2024-03-01 09:55:07) d2db9294abb52f41cc0c375dcce49f61db0a9cf1]:
#+begin_example
# A tibble: 11 × 6
   aldersinterval KØN       TID      R   Dod         M
   <fct>          <chr>   <dbl>  <dbl> <dbl>     <dbl>
 1 0              Kvinder  2019  29448    74 0.00251  
 2 1-9            Kvinder  2019 270111    24 0.0000889
 3 10-19          Kvinder  2019 332202    32 0.0000963
 4 20-29          Kvinder  2019 383578    73 0.000190 
 5 30-39          Kvinder  2019 336414   128 0.000380 
 6 40-49          Kvinder  2019 378914   342 0.000903 
 7 50-59          Kvinder  2019 397594  1160 0.00292  
 8 60-69          Kvinder  2019 336747  2855 0.00848  
 9 70-79          Kvinder  2019 293474  6016 0.0205   
10 80-89          Kvinder  2019 129929  8878 0.0683   
11 90+            Kvinder  2019  32094  6921 0.216
#+end_example

Med disse tal fra den rigtige befolkning konstruerer vi
overlevelsestavlen, som beskriver dødeligheden i en hypotetisk
befolkning, der bliver født i 2019 og lever hele deres ``liv'' igennem
alle alderstrin i 2019, hvor de bliver udsat for mortalitetsraterne
fra 2019.

#+ATTR_LATEX: :options otherkeywords={hent_mortalitetsrate_data,filter,mutate,overlevelsestavle}, deletekeywords={c,rep,print,seq,R}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
x <- mutate(x,a = c(0.1,4.5,rep(5,9)),k = c(1,9,rep(10,9)))
tavle_kvinder <- overlevelsestavle(x,
                                   mortalitet = "M",
                                   alder = "aldersinterval")
print(tavle_kvinder,digits = 2)
#+END_SRC

#+RESULTS[(2024-03-01 09:56:07) 05faec4af649b08c3f49cb5ab3d81b1e6fed6ab5]:
#+begin_example
# A tibble: 11 × 9
   Alder      l     d     p        q     o      L        T     e
   <fct>  <dbl> <dbl> <dbl>    <dbl> <dbl>  <dbl>    <dbl> <dbl>
 1 0     100000   251 0.997 0.00251  1      99774 8334430. 83.3 
 2 1-9    99749    80 0.999 0.000799 0.997 897385 8234656. 82.6 
 3 10-19  99670    96 0.999 0.000963 0.997 996216 7337271. 73.6 
 4 20-29  99574   189 0.998 0.00190  0.996 994789 6341056. 63.7 
 5 30-39  99384   377 0.996 0.00380  0.994 991955 5346266. 53.8 
 6 40-49  99007   890 0.991 0.00899  0.990 985620 4354311. 44.0 
 7 50-59  98117  2821 0.971 0.0288   0.981 967065 3368691. 34.3 
 8 60-69  95296  7751 0.919 0.0813   0.953 914204 2401626. 25.2 
 9 70-79  87545 16278 0.814 0.186    0.875 794062 1487422. 17.0 
10 80-89  71267 36296 0.491 0.509    0.713 531192  693360.  9.73
11 90+    34971 34971 0     1        0.350 162168  162168.  4.64
#+end_example


#+Label: tab:overlevelstavle-kolonner
#+CAPTION: Forklaring af kolonner i en overlevelsestavle
#+ATTR_LATEX: :align l|l
| Kolonne | Betydning                                                                                |
|---------+------------------------------------------------------------------------------------------|
| =Alder= | Aldersinterval                                                                           |
| =l=     | Dekrementfunktion: Antal tabelpersoner i starten af intervallet                          |
| =d=     | Antal døde i intervallet                                                                 |
| =p=     | Sandsynlighed for at overleve i intervallet givet i live ved intervallets start          |
| =q=     | Dødshyppighed: sandsynlighed for at dø i intervallet givet i live ved intervallets start |
| =o=     | Sandsynlighed for at overleve indtil starten af intervallet                              |
| =L=     | Samlet risikotid i intervallet                                                           |
| =T=     | Samlet levetid fra starten af intervallet                                                |
| =e=     | Middelrestlevetid (i første interval =  middellevetid)                                   |

Fra overlevelsestavlen aflæser vi af kolonne =e=: under antagelsen af,
at mortalitetsraterne i 2019 ikke ændrer sig i al fremtid, vil man
forvente, at en nyfødt pige lever 83,3 år og at en kvinde som er 30 år
gammel kan forvente at leve 53,8 år.

* Konstruktion af overlevelsestavler

Overlevelsestavler beskriver, hvordan en tænkt lukket fødselskohorte
reduceres med stigende alder alene på grund af dødsfald. Fordi
kohorten er lukket, er død den eneste mulige afgang fra kohorten. Der
tages udgangspunkt i en fiktiv tabelbefolkning bestående af
\(\ell_0\) personer, som antages at være født på nøjagtig samme
tidspunkt. Antallet af fiktive tabelpersoner \(\ell_0\) kaldes for
`radix', og radix sættes typisk til $\ell_0=100.000$.

** Dekrementfunktionen

Funktionen \(\ell_x\) angiver, hvor mange tabelpersoner som stadigvæk er i
live ved alder \(x\) og beskriver, hvordan tabelbefolkningen reduceres
på grund af dødsfald. Startværdien \(\ell_0\) angiver, hvor mange
tabelpersoner, der er i tabelbefolkningen helt i begyndelsen, hvor alder
er lig med \(0\), og \(\ell_{30}\) angiver hvor mange tabelpersoner som
er i live ved alder \(30\). Fordi \(\ell_x\) er monotont faldende som
funktion af alder, det vil sige, at der gælder
\(\ell_x\ge\ell_{x+1}\), kalder man den for dekrementfunktionen. Af
tabellen kan man aflæse, hvor mange personer som forventes at overleve til en 
bestemt alder. For eksempel betyder \(\ell_{30}=99.345\), at \(99.345\) personer ud af
\(\ell_0=100.000\) tabelpersoner stadigvæk er i
live ved alder \(30\). I dette eksempel er overlevelsessandsynligheden
i tabelbefolkningen ved alder \(30\) lig med
#+begin_export latex
\begin{equation*}
o(30)=\frac{\ell_{30}}{\ell_0} = \frac{99.345}{100.000} = 99,3\%,
\end{equation*}
#+end_export
eftersom overlevelsesfunktionen er defineret som
#+begin_export latex
\begin{equation*}
o_x=\frac{\ell_x}{\ell_0}. 
\end{equation*}
#+end_export
Under konstruktionen af overlevelsestavler er opgaven at beregne
dekrementfunktionens værdier \(\ell_x\) for alle alderstrin \(x=0,1,
\dots, x^{max}\) hvor \(x^{max}\) er det sidste alderstrin. Per
konstruktion dør alle resterende
tabelpersoner i det sidste alderstrin - det vil sige
\(\ell_{x^{max}+1}=0\) og dermed også \(o_{x^{max}+1}=0\). Vi vil forklare
hvorfor senere. 

** Dødshyppigheder

Dødshyppigheden \(\qxk\) beskriver for en person med eksakt alder
\(x\) sandsynligheden for at dø inden alderen \(x+k\). Dødshyppigheder
forbinder den ægte, åbne befolkning, som man interesserer sig for, med
den tænkte, lukkede tabelbefolkning, der definerer
overlevelsestavlen. Man beregner dødshyppigheder baseret på
aldersspecifikke mortalitetsrater, og den underliggende idé er, at
mortalitetsraterne er ens i den ægte befolkning og i tabelbefolkningen
for begge køn og alle alderstrin.

#+begin_export latex
\mybox{Bemærkning til notation:\\

Det er standardnotation i demografi at have indeks på begge
sidder af symbolet ligesom i \qxk. Her er indeks til højre 
startalderen og indeks til venstre er antal år, som tælles med inklusive
startalderen. 
Det er lidt forvirrende, fordi
intervallet inkluderer startalderen \(x\):
\begin{center}
\begin{tabular}{lm{4em}rrl}
Symbol & Start & Længden & Slut & Betydning\\[0pt]
\hline
\({}_{1}D_{0}\) & 0 & 1 & 1 & Antal døde i alder \(0\)\\[0pt]
\({}_{4}D_{1}\) & 1 & 4 & 4 & Antal døde i alder 1, 2, 3, 4\\[0pt]
\({}_{5}D_{5}\) & 5 & 5 & 9 & Antal døde i alder 5, 6, 7, 8, 9\\[0pt]
\end{tabular}
\end{center}
Vi ændrer nu også notationen for de aldersspecifikke
mortalitetsrater. I Kapitel 2 har vi brugt \(M_x\) for mortalitetsraten
i det \(x\)-te aldersinterval.
Fra nu af bruger vi den mere præcise betegnelse
\(\Mxk\) for mortalitetsraten i det aldersinterval, som starter i alderen \(x\)
og slutter i alderen \(x+k-1\).
}
#+end_export

# | Symbol          | Startalder | Længden | Slutalder | Betydning              |
# |-----------------+------------+---------+-----------+------------------------|
# | \({}_{1}D_{0}\) |          0 |       1 |         1 | Antal døde i \([0,1)\) |
# | \({}_{4}D_{1}\) |          1 |       4 |         4 | Antal døde i \([1,4)\) |
# | \({}_{5}D_{5}\) |          5 |       5 |         9 | Antal døde i \([5,9)\) |

*** Approksimationsformlen

For at beregne dødssandsynligheder i den ægte befolkning vil man gerne
dividere antal dødsfald i en kalenderperiode med antal personer i
starten af perioden. Problemet er, at den ægte befolkning er /åben/:
Dødsfald bliver ikke registreret for personer, som udvandrer i
perioden, og både udvandrere og indvandrere i perioden bidrager ikke med
risikotid til hele perioden. Ideen er derfor at tilnærme
dødshyppighederne baseret på mortalitetsrater. Aldersspecifikke
mortalitetsrater kan beregnes på de registrerede data, ved at dividere
antal dødsfald i befolkningen med risikotiden, hvor indvandrere og
udvandrere kun bidrager med den tid de har været i befolkningen (se
Kapitel 1 og 2). Nøglen til en tilnærmelse af dødshyppighederne
baseret på mortalitetsrater er følgende centrale formel for
overlevelsestavlen:

#+begin_export latex 
\begin{equation}\label{k3-dhyppig}
\qxk= \frac{k\cdot \Mxk}{1+(k-\a{k})\cdot \Mxk}.
\end{equation}
#+end_export

Formlen afhænger aldersspecifikke mortalitetsrater \Mxk, længden af
aldersintervallet \(k\) og også en konstant \(\a{k}\), som kaldes
Chiang's \(a\)[fn:87]. Konstanten \(\a{k}\) beskriver den gennemsnitlige levetid
i aldersintervallet for personer, der døde mellem alderen \(x\) og
alderen \(x+k-1\). Dermed beskriver \((k-\a{k})\) den gennemsnitlige
tid, som en person, der døde i aldersintervallet, var død.  Hvis vi for
eksempel ser på et aldersinterval mellem 70 og 79 år, og en person døde
i alder 74, så har den person været i live i 4 år (70, 71, 72, 73) og
død i 6 år (74, 75, 76, 77, 78, 79). En person som døde i alder 78 har
været i live i 8 år og død i 2 år, og så videre. Værdien af
\({}_{10}a_{70}\) skal afspejle det gennemsnitlige antal år, som
personer, der døde i denne aldersgruppe, var i live. For de fleste
intervaller vil man antage, at gennemsnittet ligger i midten, altså i
eksemplet vil man vælge \({}_{10}a_{70} = 5\).

[fn:87] Chin Long Chiang (1984). The Life table and its applications. Malabar, Fla. : Krieger

*** Chiang's \(a\)
:PROPERTIES:
:CUSTOM_ID: chiang
:END:
For at beregne dødshyppigheder med den centrale formel
eqref:k3-dhyppig har vi brug for at specificere Chiang's \(a\) for alle
aldersintervaller. Chiang's \(a\) skal tilnærme det forventede antal år
levet i intervallet af en person, som dør i intervallet. Hvis Chiang's
a opfylder dette, kan vi tilnærme den samlede dødstid, som alle
personer, der døde i aldersintervallet, har været døde:
#+begin_export latex
\begin{equation*}
\begin{split}
\text{Samlede dødstid i aldersintervallet}&=(k- \a{k})\cdot\Dxk,\\
 k &= \text{Antal år i aldersintervallet}\\
 \Dxk &= \text{Antal døde i aldersintervallet}\\
 k-\a{k} &= \text{Gennemsnitlige antal dødsår i intervallet}\\
 \{x,x+1,\dots,x+k-1\} &= \text{Aldre i intervallet}.
\end{split}
\end{equation*}
#+end_export
Hvis vi antager at dødstider er
lige fordelt i aldersintervallet, altså at det er lige så sandsynligt at
dø i starten, som det er at dø i slutningen af aldersintervallet, er
det rimeligt at vælge
#+begin_export latex
\begin{equation*}
\a{k} = \frac k 2.
\end{equation*}
#+end_export
Det første og sidste aldersinterval vil dog altid kræve særlige
værdier af \a{k}. I det første leveår er dødstiderne meget skævt
fordelt over året - de fleste dødstider inden 1-års fødselsdagen ligger
kort efter fødslen. Derfor sætter vi \(\a[0]{1}=0,1\). For det sidste
interval \(x^{max}\) vælger vi
#+begin_export latex
\begin{equation}\label{eq:amax}
\a[x^{max}]{\infty} =
\frac{1}{{}_\infty M_{x^{max}}}, 
\end{equation}
#+end_export
så dødshyppigheden i det sidste interval bliver 1, og det betyder, at
alle tabelpersoner dør i det sidste aldersinterval, dvs. \({}_\infty q_{x^{max}} = 1\).
ved formel eqref:k3-dhyppig. 

#+Label: tab-K3.1
#+CAPTION: Tabellen viser, hvordan vi vælger Chiang's \(a\) for 1-års, 5-års og 10-års aldersintervaller.
#+ATTR_LATEX: :align l|l|l 
|                        | 5-års aldersintervaller                         | 10-års aldersintervaller                        |
|------------------------+-------------------------------------------------+-------------------------------------------------|
| Første leveår          | \(\a[0]{1}=0,1\)                                | \(\a[0]{1}=0,1\)                                |
| Aldersinterval 1-5 år  | \(\a[1]{4}= 4\cdot 0,5=2\)                      | \(\a[1]{9}= 9\cdot 0,5=4,5\)                    |
| Alle andre intervaller | \(\a[5]{k}=5\cdot 0,5\)=2,5                     | \(\a[10]{k}=10\cdot 0,5=5\)                     |
| Sidste aldersinterval  | \(a_{x^{max}}=\frac{1}{{}_\infty M_{x^{max}}}\) | \(a_{x^{max}}=\frac{1}{{}_\infty M_{x^{max}}}\) |

*** Forklaring af den centrale formel

I det følgende skal vi på en uformel måde forklare formel
eqref:k3-dhyppig. Hvis den ægte befolkning var lukket, altså uden
forekomst af ind- og udvandring, ville man kunne beregne
dødshyppighederne simpelt som antal dødsfald i aldersintervallet
divideret med antal personer i starten af aldersintervallet:
#+begin_export latex
\begin{equation*}
\text{Dødshyppighed} = \frac{\text{Antal dødsfald i aldersintervallet}}{\text{Antal personer i starten}}.
\end{equation*}
#+end_export
Hvis aldersintervallet er over \(k\) år gælder
#+begin_export latex
\begin{equation*}
\text{Antal personer i starten} = \frac{\text{Risikotid} + \text{Dødstid}}{k}.
\end{equation*}
#+end_export
Her er risikotiden det samlede antal år, som befolkningens personer har
levet (i aldersintervallet), og dødstiden er tilsvarende det samlede
antal år, som befolkningens personer var døde. Med denne formel kan
dødshyppigheden skrives som
#+begin_export latex
\begin{equation}\label{eq:k3-uformel}
\text{Dødshyppighed} = \frac{k\cdot \text{Antal dødsfald i aldersinterval}}{\text{Risikotid}+\text{Dødstid}}.
\end{equation}
#+end_export
Vi sætter Chiang's \(a\) sådan, at
#+begin_export latex
\begin{equation*}
\text{Dødstid i aldersinterval}=(k- \a{k})\cdot\Dxk
\end{equation*}
#+end_export
er en god tilnærmelse af den samlede dødstid, som alle personer der
døde i aldersintervallet, har været døde (cf., afsnit ref:chiang). Hvis
vi nu anvender formlen for den aldersspecifikke mortalitetsrate
fra Kapitel 2, 
#+begin_export latex
\begin{equation*}
\Mxk = \frac{\Dxk}{\Rxk},
\end{equation*}
#+end_export
ser vi at den centrale formel
eqref:k3-dhyppig faktisk er lig med formel eqref:eq:k3-uformel:
#+begin_export latex
\begin{align*}
\frac{k\cdot\Mxk}{1+(k-\a{k})\cdot \Mxk} &=\frac{k\cdot\frac{\Dxk}{\Rxk}}{1+(k-\a{k})\cdot \frac{\Dxk}{\Rxk}}\\
&=\frac{k\cdot\Dxk}{\Rxk\cdot(1+(k-\a{k})\cdot \frac{\Dxk}{\Rxk})}\\
&=\frac{k\cdot \Dxk}{\Rxk+(k-\a{k})\cdot \Dxk}.
\end{align*}
#+end_export

*** Beregningen af antal dødsfald og overlevelser

Vi fortsætter nu konstruktionen af overlevelsestavlen. Vi starter med
en radix af \(\ell_0\) tabelpersoner. For at beregne antal
tabelpersoner som overlever indtil det første alderstrin, \(x=1\),
skal vi beregne, hvor mange tabelpersoner som dør mellem alder \(x=0\) og
alder \(x=1\). For at beregne hvor mange tabelpersoner, der overlever
indtil alder \(x+k\), skal vi beregne, hvor mange af de resterende
\(\ell_x\) tabelpersoner der dør i aldersintervallet. Vi betegner med
\(\d{k}\) antallet af tabelpersoner, som dør mellem alder \(x\) og
alder \(x+k-1\). Dermed er \(\d{1}\) antallet af tabelpersoner, som
dør ved alder \(x\). Sandsynligheden for at dø mellem to alderstrin
(dødshyppighederne) er det centrale element ved konstruktionen af
overlevelsestavlen. Vi beregner antal dødsfald i aldersintervallet ved
at gange antal tabelpersoner i starten af intervallet med
dødshyppigheden:
#+begin_export latex
\begin{equation}\label{antaltabeldod}
\d{k} = \qxk\cdot\ell_x.
\end{equation}
#+end_export
Det er vigtigt at skelne mellem antal døde \(\Dxk\) i den ægte
befolkning og antal døde \(\d{k}\) i tabelbefolkningen. Med formel
eqref:antaltabeldod er det en enkel sag at finde antallet af
tabelpersoner der er i live i starten af det næste aldersinterval:
#+begin_export latex
\begin{equation*}
\ell_{x+k}=\ell_{x} - \d{k}.
\end{equation*}
#+end_export
Alternativt kan vi starte med at beregne dekrementfunktionen baseret
på dødshyppigheden
#+begin_export latex
\begin{equation*}
\ell_{x+k}=\ell_{x}\cdot (1-{}_kq_x).
\end{equation*}
#+end_export
Bagefter er det simpelt at beregne antal dødsfald som
#+begin_export latex
\begin{equation*}
\d{k} = l_{x} - l_{x+k}.
\end{equation*}
#+end_export
Med disse formler kan vi konstruere overlevelsestavlens vigtigste
kolonner (\(\ell_0\) og \(\d{k}\)). Vi beskriver nu de vigtigste
dødelighedsmål, som overlevelsestavlen viser.

*** Beregning af middelrestlevetid og middellevetid 

Vi betegner med \(\L{k}\) den samlede gennemlevede tid i
tabelbefolkningen i alderen mellem \(x\) og \(x+k-1\). Da dødsfald er
eneste afgangsårsag i tabelbefolkningen, har vi
#+begin_export latex
\begin{align*}
\L{k} &= \text{bidrag fra overlevende + bidrag fra døde}\\
    &= k\cdot \ell_{x+k} + \a{k}\cdot \d{k}\\
    &= \a{k}\cdot\ell_x + (k- \a{k})\cdot \ell_{x+k}.
\end{align*}
#+end_export

Vi skal nu beregne den /forventede restlevetid/ for en \(x\)-årig
tabelperson. For en nyfødt er \(x=0\) og dermed bliver den forventede
restlevetid til den forventede levetid, som betegnes med
/middellevetid/. Lad \(T_x\) angive den samlede levetid i
tabelbefolkningen efter \(x\)-års fødselsdagen, specielt er \(T_0\)
den samlede levetid i tabelbefolkningen. Vi beregner
#+begin_export latex
\begin{align*}
T_x &= \L{k} + \cdots + \L[x^{max}]{k}\\
    &= \a{k}\cdot\ell_x + (k- \a{k})\cdot \ell_{x+k} + \cdots + \a[x^{max}]{\infty}\cdot\ell_{x^{max}}.
\end{align*}
#+end_export
I tabelbefolkningen overlever \(\ell_x\) personer til deres \(x\)-års
fødselsdag, så den gennemsnitlige levetid efter \(x\)-års fødselsdagen
bliver
#+begin_export latex
\begin{equation}\label{eq:restlevetid}
e_x=\frac{T_x}{\ell_x} = \text{gennemsnitlige restlevetid}.
\end{equation}
#+end_export
Denne kvotient kaldes den forventede restlevetid eller
middelrestlevetid for en \(x\)-årig tabelperson. På tilsvarende vis
bliver middellevetid beregnet som
#+begin_export latex
\begin{equation}\label{eq:middellevetid}
e_0=\frac{T_0}{\ell_0} = \text{middellevetid}.
\end{equation}
#+end_export

*** Fortolkning

Når man fortolker middellevetid og middelrestlevetid, er det vigtigt
at huske at fremhæve at beregningen bygger på en hypotetisk
tabelbefolkning, som lever hele deres liv i en bestemt
kalenderperiode. Danmarks Statistik forklarer middelrestlevetiden
sådan[fn:1]:

#+begin_export latex
\mybox{ Middelrestlevetiden er det gennemsnitlige antal år, som personer på en given
fødselsdag har tilbage at leve i, {\it hvis deres dødelighed fremover
(alder for alder) svarer til det niveau, som er konstateret i den
aktuelle periode}.}
#+end_export

[fn:1] https://www.dst.dk/da/Statistik/emner/borgere/befolkning/middellevetid

** Overlevelsestavle med 5-års intervaller

#+ATTR_LATEX: :options otherkeywords={hent_mortalitetsrate_data,filter,mutate,overlevelsestavle}, deletekeywords={c,rep,print,seq,R}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
x5 <- hent_mortalitetsrate_data(tid = 2019,
                                breaks = c(0,1,seq(5,95,5),Inf),
                                køn = "kvinder")
x5 <- mutate(x5,M = Dod/R)
x5 <- mutate(x5,a = c(0.1,2,rep(2.5,19)),k = c(1,4,rep(5,19)))
tavle_kvinder_5 <- overlevelsestavle(x5,
                                     mortalitet = "M",
                                     alder = "aldersinterval")
print(tavle_kvinder_5,digits = 2,n = 100)
#+END_SRC

#+RESULTS[(2024-03-01 17:24:11) 75f0b77929bc9ca8e1687e834da0c63bfe4265db]:
#+begin_example
# A tibble: 21 ×
#   9
   Alder      l     d     p        q     o      L        T     e
   <fct>  <dbl> <dbl> <dbl>    <dbl> <dbl>  <dbl>    <dbl> <dbl>
 1 0     100000   251 0.997 0.00251  1      99774 8338941. 83.4 
 2 1-4    99749    40 1.00  0.000402 0.997 398917 8239167. 82.6 
 3 5-9    99709    40 1.00  0.000398 0.997 498447 7840250. 78.6 
 4 10-14  99669    30 1.00  0.000303 0.997 498272 7341804. 73.7 
 5 15-19  99639    66 0.999 0.000658 0.996 498033 6843532. 68.7 
 6 20-24  99574    82 0.999 0.000823 0.996 497664 6345499. 63.7 
 7 25-29  99492   107 0.999 0.00108  0.995 497192 5847835. 58.8 
 8 30-34  99385   146 0.999 0.00147  0.994 496558 5350643. 53.8 
 9 35-39  99238   233 0.998 0.00235  0.992 495609 4854085. 48.9 
10 40-44  99005   322 0.997 0.00325  0.990 494219 4358476. 44.0 
11 45-49  98683   561 0.994 0.00568  0.987 492012 3864257. 39.2 
12 50-54  98122  1135 0.988 0.0116   0.981 487773 3372245. 34.4 
13 55-59  96987  1709 0.982 0.0176   0.970 480661 2884472. 29.7 
14 60-64  95278  3081 0.968 0.0323   0.953 468685 2403810. 25.2 
15 65-69  92196  4715 0.949 0.0511   0.922 449195 1935126. 21.0 
16 70-74  87482  6638 0.924 0.0759   0.875 420815 1485930. 17.0 
17 75-79  80844 10209 0.874 0.126    0.808 378699 1065115. 13.2 
18 80-84  70635 15912 0.775 0.225    0.706 313396  686417.  9.72
19 85-89  54723 21608 0.605 0.395    0.547 219597  373021.  6.82
20 90-94  33116 20382 0.385 0.615    0.331 114623  153424.  4.63
21 95+    12734 12734 0     1        0.127  38801   38801.  3.05
#+end_example

** Overlevelsestavle med 1-års intervaller

#+ATTR_LATEX: :options otherkeywords={hent_mortalitetsrate_data,filter,mutate,overlevelsestavle}, deletekeywords={c,rep,print,seq,R}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
x1 <- hent_mortalitetsrate_data(tid = 2019,
                               breaks = c(0:99,Inf),
                               køn = "kvinder",
                               right = FALSE)
x1 <- mutate(x1,M = Dod/R)
x1 <- mutate(x1,a = c(0.1,rep(0.5,99)),k = rep(1,100))
tavle_kvinder_1 <- overlevelsestavle(x1,
                                     mortalitet = "M",
                                     alder = "aldersinterval")
print(tavle_kvinder_1,digits = 2,n = 100)
#+END_SRC
\footnotesize

#+RESULTS[(2024-03-06 11:46:33) 444c66e4cfb03e2957bdcf49ab735107a359eb46]:
#+begin_example
# A tibble: 100
#   × 9
    Alder      l     d     p         q      o     L        T     e
    <fct>  <dbl> <dbl> <dbl>     <dbl>  <dbl> <dbl>    <dbl> <dbl>
  1 0     100000   251 0.997 0.00251   1      99774 8340603. 83.4 
  2 1-1    99749    16 1.00  0.000164  0.997  99741 8240828. 82.6 
  3 2-2    99733     7 1.00  0.0000658 0.997  99730 8141087. 81.6 
  4 3-3    99726     7 1.00  0.0000671 0.997  99723 8041357. 80.6 
  5 4-4    99720    10 1.00  0.000105  0.997  99714 7941634. 79.6 
  6 5-5    99709    14 1.00  0.000142  0.997  99702 7841920. 78.6 
  7 6-6    99695     3 1.00  0.0000343 0.997  99693 7742218. 77.7 
  8 7-7    99692    10 1.00  0.000101  0.997  99687 7642524. 76.7 
  9 8-8    99682     6 1.00  0.0000638 0.997  99678 7542838. 75.7 
 10 9-9    99675     6 1.00  0.0000619 0.997  99672 7443159. 74.7 
 11 10-10  99669     3 1.00  0.0000304 0.997  99668 7343487. 73.7 
 12 11-11  99666     3 1.00  0.0000300 0.997  99665 7243820. 72.7 
 13 12-12  99663     9 1.00  0.0000915 0.997  99659 7144155. 71.7 
 14 13-13  99654     9 1.00  0.0000906 0.997  99649 7044496. 70.7 
 15 14-14  99645     6 1.00  0.0000607 0.996  99642 6944847. 69.7 
 16 15-15  99639    24 1.00  0.000241  0.996  99627 6845205. 68.7 
 17 16-16  99615     3 1.00  0.0000308 0.996  99613 6745578. 67.7 
 18 17-17  99612     9 1.00  0.0000907 0.996  99607 6645965. 66.7 
 19 18-18  99603     9 1.00  0.0000886 0.996  99598 6546358. 65.7 
 20 19-19  99594    20 1.00  0.000203  0.996  99584 6446759. 64.7 
 21 20-20  99574    17 1.00  0.000169  0.996  99565 6347176. 63.7 
 22 21-21  99557    14 1.00  0.000139  0.996  99550 6247610. 62.8 
 23 22-22  99543    16 1.00  0.000158  0.995  99535 6148060. 61.8 
 24 23-23  99527    16 1.00  0.000156  0.995  99520 6048525. 60.8 
 25 24-24  99512    20 1.00  0.000198  0.995  99502 5949005. 59.8 
 26 25-25  99492    20 1.00  0.000201  0.995  99482 5849503. 58.8 
 27 26-26  99472    28 1.00  0.000277  0.995  99458 5750021. 57.8 
 28 27-27  99445    15 1.00  0.000154  0.994  99437 5650563. 56.8 
 29 28-28  99429    23 1.00  0.000232  0.994  99418 5551126. 55.8 
 30 29-29  99406    21 1.00  0.000210  0.994  99396 5451708. 54.8 
 31 30-30  99385    16 1.00  0.000163  0.994  99377 5352312. 53.9 
 32 31-31  99369    39 1.00  0.000397  0.994  99349 5252935. 52.9 
 33 32-32  99330    29 1.00  0.000290  0.993  99315 5153586. 51.9 
 34 33-33  99301    26 1.00  0.000266  0.993  99288 5054271. 50.9 
 35 34-34  99274    36 1.00  0.000367  0.993  99256 4954983. 49.9 
 36 35-35  99238    46 1.00  0.000467  0.992  99215 4855727. 48.9 
 37 36-36  99192    41 1.00  0.000413  0.992  99171 4756512. 48.0 
 38 37-37  99151    21 1.00  0.000214  0.992  99140 4657341. 47.0 
 39 38-38  99129    88 0.999 0.000887  0.991  99085 4558201. 46.0 
 40 39-39  99041    37 1.00  0.000377  0.990  99023 4459116. 45.0 
 41 40-40  99004    51 0.999 0.000513  0.990  98979 4360093. 44.0 
 42 41-41  98953    39 1.00  0.000395  0.990  98934 4261114. 43.1 
 43 42-42  98914    73 0.999 0.000733  0.989  98878 4162180. 42.1 
 44 43-43  98842    79 0.999 0.000804  0.988  98802 4063302. 41.1 
 45 44-44  98762    77 0.999 0.000784  0.988  98724 3964500. 40.1 
 46 45-45  98685   115 0.999 0.00117   0.987  98627 3865777. 39.2 
 47 46-46  98570    60 0.999 0.000609  0.986  98540 3767150. 38.2 
 48 47-47  98510   131 0.999 0.00133   0.985  98444 3668610. 37.2 
 49 48-48  98379   123 0.999 0.00125   0.984  98318 3570165. 36.3 
 50 49-49  98257   133 0.999 0.00135   0.983  98190 3471848. 35.3 
 51 50-50  98124   169 0.998 0.00172   0.981  98039 3373658. 34.4 
 52 51-51  97955   163 0.998 0.00167   0.980  97873 3275618. 33.4 
 53 52-52  97792   251 0.997 0.00256   0.978  97666 3177745. 32.5 
 54 53-53  97541   262 0.997 0.00269   0.975  97410 3080078. 31.6 
 55 54-54  97279   280 0.997 0.00287   0.973  97139 2982668. 30.7 
 56 55-55  96999   248 0.997 0.00256   0.970  96875 2885530. 29.7 
 57 56-56  96751   296 0.997 0.00306   0.968  96602 2788655. 28.8 
 58 57-57  96454   348 0.996 0.00361   0.965  96280 2692052. 27.9 
 59 58-58  96106   373 0.996 0.00388   0.961  95919 2595772. 27.0 
 60 59-59  95733   460 0.995 0.00480   0.957  95503 2499853. 26.1 
 61 60-60  95273   471 0.995 0.00494   0.953  95038 2404350. 25.2 
 62 61-61  94802   599 0.994 0.00632   0.948  94503 2309312. 24.4 
 63 62-62  94203   611 0.994 0.00649   0.942  93898 2214809. 23.5 
 64 63-63  93592   660 0.993 0.00705   0.936  93262 2120911. 22.7 
 65 64-64  92932   746 0.992 0.00803   0.929  92559 2027649. 21.8 
 66 65-65  92186   823 0.991 0.00893   0.922  91775 1935090. 21.0 
 67 66-66  91363   873 0.990 0.00956   0.914  90927 1843315. 20.2 
 68 67-67  90490   985 0.989 0.0109    0.905  89997 1752389. 19.4 
 69 68-68  89505  1030 0.988 0.0115    0.895  88990 1662391. 18.6 
 70 69-69  88475  1009 0.989 0.0114    0.885  87970 1573402. 17.8 
 71 70-70  87466  1113 0.987 0.0127    0.875  86909 1485432. 17.0 
 72 71-71  86353  1137 0.987 0.0132    0.864  85784 1398522. 16.2 
 73 72-72  85215  1329 0.984 0.0156    0.852  84551 1312738. 15.4 
 74 73-73  83887  1454 0.983 0.0173    0.839  83159 1228187. 14.6 
 75 74-74  82432  1600 0.981 0.0194    0.824  81632 1145028. 13.9 
 76 75-75  80832  1857 0.977 0.0230    0.808  79904 1063396. 13.2 
 77 76-76  78975  1928 0.976 0.0244    0.790  78011  983492. 12.5 
 78 77-77  77047  1968 0.974 0.0255    0.770  76063  905481. 11.8 
 79 78-78  75078  2224 0.970 0.0296    0.751  73967  829419. 11.0 
 80 79-79  72855  2390 0.967 0.0328    0.729  71660  755452. 10.4 
 81 80-80  70465  2698 0.962 0.0383    0.705  69116  683792.  9.70
 82 81-81  67767  2878 0.958 0.0425    0.678  66328  614675.  9.07
 83 82-82  64889  3227 0.950 0.0497    0.649  63275  548347.  8.45
 84 83-83  61662  3529 0.943 0.0572    0.617  59897  485072.  7.87
 85 84-84  58133  3837 0.934 0.0660    0.581  56215  425174.  7.31
 86 85-85  54296  3922 0.928 0.0722    0.543  52335  368960.  6.80
 87 86-86  50374  4430 0.912 0.0879    0.504  48159  316625.  6.29
 88 87-87  45944  4262 0.907 0.0928    0.459  43813  268465.  5.84
 89 88-88  41682  4616 0.889 0.111     0.417  39375  224652.  5.39
 90 89-89  37067  4390 0.882 0.118     0.371  34872  185278.  5.00
 91 90-90  32677  4427 0.865 0.135     0.327  30464  150406.  4.60
 92 91-91  28250  4264 0.849 0.151     0.282  26118  119942.  4.25
 93 92-92  23986  4081 0.830 0.170     0.240  21945   93824.  3.91
 94 93-93  19905  3563 0.821 0.179     0.199  18124   71879.  3.61
 95 94-94  16342  3425 0.790 0.210     0.163  14630   53756.  3.29
 96 95-95  12918  3040 0.765 0.235     0.129  11398   39125.  3.03
 97 96-96   9877  2494 0.748 0.252     0.0988  8631   27728.  2.81
 98 97-97   7384  1939 0.737 0.263     0.0738  6414   19097.  2.59
 99 98-98   5444  1690 0.690 0.310     0.0544  4599   12683.  2.33
100 99+     3754  3754 0     1         0.0375  8084    8084.  2.15
#+end_example
\normalsize

** Danmark Statistik

Danmark Statistik offentliggør egne beregninger af middellevetiden og
middelrestlevetiden.[fn:3] I dette afsnit forklarer vi, hvordan Danmark
Statistiks beregninger bliver mere præcise, fordi de bruger datoer for
fødsler, dødsfald og folkevandringer. [fn:4]

Med etableringen af den personstatistiske database har Danmarks
Statistik fået nye muligheder for at beregne dødshyppighederne mere
korrekt, idet databasen for alle personer i Danmark indeholder eksakt
information om eventuel dødsdato og ind- og udvandringsdatoer. Der
kan således for hver enkelt person udregnes nøjagtigt, hvor mange dage
personen i en årsperiode har været i Danmark og hvor mange af dagene i
årsperioden, personen har været død. Den søgte dødshyppighed skal
præcist angive sandsynligheden for at dø i et bestemt alderstrin, 
dvs. mellem to fødselsdage. For at opnå denne hyppighed laves
der en særlig beregning for hver enkelt person fra fødselsdag til
fødselsdag i en periode, der omfatter to kalenderår. I
offentliggørelsen af middellevetid fra 19. marts 2010 er det
kalenderårene 2008 og 2009, der ligger til grund for
beregningerne. For alle personer, der var i den danske befolkning på
et eller andet tidspunkt mellem deres fødselsdag i 2008 og i 2009, er
der lavet en beregning for antallet af dage, personen var i Danmark og
antallet af dage, personen var død i perioden mellem de to
fødselsdage. For personer, der ikke dør mellem to fødselsdage, vil
antallet af dage som død naturligvis være 0.  Efterfølgende laves der
en sammenlægning for personer med samme køn og alderstrin for at få
det samlede antal levedage og dødsdage. Personer vil placeres på det
alderstrin, som svarer til det antal år, de fyldte i startåret,
hvilket i eksemplet vil sige 2008. En person, som fyldte 60 år 1. januar 2008 vil f.eks. tilhøre de
60-årige. Det samme vil en person, der fyldte 60 år 31. december 2008.
Der kan altså i yderste konsekvens være næsten et års forskel mellem
den periode, som personer på samme alderstrin følges.

[fn:3] https://www.dst.dk/da/Statistik/emner/borgere/befolkning/middellevetid.
[fn:4] https://www.dst.dk/ext/36380110073/0/befolkning/Hvordan-beregner-vi-middellevetid?--pdf


*** COMMENT Den søgte dødshyppighed skal afspejle sandsynligheden for at dø mellem to fødselsdage 
#+ATTR_LATEX: :width 0.7\textwidth
[[~/metropolis/Teaching/Demography/worg/lecturenotes/lexis-c-grupper.png]]

*** COMMENT Beregning af dødshyppighed med eksakte fødsels- og dødsdatoer[fn:17] 
:PROPERTIES:
:CUSTOM_ID: dst-hyp
:END:
0. I kalenderperioden \([t_1,t_2]\) bestemmes alle personer som enten
   fejrer deres \(x\)-te fødselsdag eller indvandrer som \(x\)-årig.\bigskip
1. Bland disse personer tælles antal døde \({}_1D_x\).\bigskip
2. For hver person tælles antal levedage på alderstrin x med hensyn til eventuelle indvandrings, udvandrings- og dødsdatoer.\bigskip
2. For hver person som dør på alderstrin \(x\), beregnes også antal ``dødedage'' 
   som antal dage mellem dødsdato og den næste fødselsdag. \bigskip
4. Dødshyppighed beregnes som \vspace{-.5em}
  #+begin_export latex
  \begin{equation*}
  {}_1q_x=\frac{{}_1D_x\cdot 365}{\text{antal levedage} + \text{antal dødedage}}.
    \end{equation*}
  #+end_export
#   Det gennemsnitlige antal ``dødeår'' er antal ``dødeår'' divideret med antal døde.

[fn:17] Danmark statistiks har disse datoer
*** COMMENT Beregning af dødeår og dødshyppighed med eksakte fødsels- og dødsdatoer  

  [[~/metropolis/Teaching/Demography/worg/lecturenotes/dhyp2008.png]]

* Dødsårsager

Menneskers død har forskellige årsager, som fortæller, hvad der er sket
lige inden, for eksempel en trafikulykke, eller samenfatter et kortere
eller længere sygdomsforløb, før døden indtræffer. I Danmark har man
siden 1875 samlet data om dødsårsager, som nu er verdens største
digitaliserede dødsårsagsregister [fn:88]. Dødsårsagsregisteret bygger
på dødsattester fra personer med folkeregisteradresse i Danmark, der
døde i Danmark. Den demografiske analyse af dødsårsager er formåls- og
metodemæssigt relateret til de andre fag i dette semester
(sygdomslære, epidemiologi og biostatistik). Vi bruger data fra
dødsårsagsregisteret til at konstruere årsagsspecifikke
dødelighedstavler (Afsnit ref:K3:aarsag) og til at beregne
restlivstidsrisikoen (sandsynligheden for at en \(x\)-årig dør af en
bestemt årsag).

** Gruppering af dødsårsager

Dødsårsager i dødsårsagsregisteret er opdelt i 26 A grupper, og hver A
gruppe har en eller flere B undergrupper. Der er 109
B-grupper. Statistikbankens register =DODA1= har antal døde fordelt på
26 A-grupper:
#+ATTR_LATEX: :options otherkeywords={str_detect,hent_data,hent_mortalitetsrate_data,filter,mutate,overlevelsestavle}, deletekeywords={c,rep,print,seq,R}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
da <- hent_data("doda1",årsag = "all_no_total",tid = 2022)
print(da,n = 26)
#+END_SRC
\small
#+RESULTS[(2024-03-16 09:42:04) 6104dfe5af6b79360338ac3fcd79b4606347ebec]:
#+begin_example
# A tibble: 26 × 3
   ÅRSAG                                                   TID INDHOLD
   <chr>                                                 <dbl>   <dbl>
 1 A-01 Infektiøse inkl. parasitære sygdomme              2022    1824
 2 A-02 Kræft                                             2022   15777
 3 A-03 Andre svulster (anden neoplasi)                   2022     359
 4 A-04 Sygdomme i blod (-dannende) organer, sygdomme,    2022     231
 5 A-05 Endokrine og ernæringsbetingede sygdomme samt s   2022    2003
 6 A-06 Psykiske lidelser og adfærdsmæssige forstyrrels   2022    3954
 7 A-07 Sygdomme i nervesystemet og sanseorganerne        2022    3207
 8 A-08 Hjertesygdomme                                    2022    8019
 9 A-09 Andre kredsløbssygdomme                           2022    4117
10 A-10 Sygdomme i åndedrætsorganer                       2022    6297
11 A-11 Sygdomme i fordøjelsesorganer                     2022    2379
12 A-12 Sygdomme i hud og underhud                        2022      72
13 A-13 Sygdomme i knogler, muskler og bindevæv           2022     354
14 A-14 Sygdomme i urin- og kønsorganer                   2022     948
15 A-15 Komplikationer ved svangerskab, fødsel og barsel  2022       1
16 A-16 Visse sygdomme, der opstår i perinatalperioden    2022     100
17 A-17 Medfødte misdannelser og kromosomanomalier        2022     141
18 A-18 Symptomer og abnorme fund, dårligt definerede å   2022    2337
19 A-19 Ulykker                                           2022    1692
20 A-20 Selvmord og selvmordsforsøg                       2022     572
21 A-21 Drab, overfald                                    2022      39
22 A-22 Hændelser med uvis omstændighed                   2022      45
23 A-23 Legale interventioner inkl. krigshandlinger       2022       1
24 A-23x Covid-19 - Corona                                2022    1590
25 A-24 Dødsfald uden medicinske oplysninger              2022    3062
26 Årsag ikke oplyst                                      2022     314
#+end_example
\normalsize
Vi ser, at dødsfald på grund af kræft har været den
største A-gruppe i 2022. Der er i alt 109 B-grupper, hvor hver
B-gruppe hører under en A-gruppe.  Kræft er den dødsårsag med flest
B-undergrupper. A-grupper er mere overordnede, mens B-grupper er mere
specifikke. For eksempel er der tre B-grupper som opdeler gruppen A-08
HJERTESYGDOMME I ALT:
#+ATTR_LATEX: :options otherkeywords={str_detect,hent_data,filter,mutate,overlevelsestavle}, deletekeywords={c,rep,print,seq,R}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
db <- hent_data("dodb1",årsag = "all_no_total",tid = 2022)
print(filter(db,str_detect(ÅRSAG,"A-08|B-057|B-058|B-059")))
#+END_SRC

#+RESULTS[(2024-03-16 10:06:18) 397f6237d8c092f5a934def7a415822f15671016]:
: # A tibble: 4 × 3
:   ÅRSAG                            TID INDHOLD
:   <chr>                          <dbl>   <dbl>
: 1 A-08 HJERTESYGDOMME I ALT       2022    8019
: 2 B-057 Iskæmiske hjertesygdomme  2022    3275
: 3 B-058 Blodtryksforhøjelse       2022    1462
: 4 B-059 Andre hjertesygdomme      2022    3282

** Årsagsspecifikke mortalitetsrater

For en given dødsårsag \(Q\) beregner vi de summariske årsagsspecifikke
mortalitetsrater på samme måde som de summariske mortalitetsrater som
antal begivenheder per personår. For en kalenderperiode \([t_1,t_2]\)
og risikotid \(R[t_1,t_2]\) er formlen for den årsagsspecifikke
mortalitetsrate:
#+begin_export latex
\begin{equation*}
\frac{D^Q[t_1,t_2]}{R[t_1,t_2]} = \frac{\text{Antal døde med årsag \(Q\) i perioden } [t_1,t_2]}{\text{Risikotid i perioden } [t_1,t_2]}.
\end{equation*}
#+end_export
Vi kan også beregne årsagsspecifikke mortalitetsrater i
aldersgrupper. Vi betegner med \({}_kD_x^Q\) antal dødsfald, hvor
dødsårsagen var \(Q\) i aldersgruppen af personer, der var mellem
\(x\)-år og \((x+k-1)\)-år gamle i perioden. Det giver følgende notation
for de aldersspecifikke rater:
#+begin_export latex
\begin{equation*}
\frac{{}_kD_x^Q[t_1,t_2]}{{}_kR_x[t_1,t_2]}.
\end{equation*}
#+end_export

For eksempel kan vi beregne rater af dødsulykker per 10.000 personår
blandt unge mennesker (15-29 år) og se, hvordan de har udviklet sig
siden 2007. Figur ref:fig:k3-ulykker viser at disse rater er faldet
fra omkring 1,5 dødsulykker per 10.000 personår i 2007 til omkring
0,75 dødsulykker per 10.000 personår i 2022.

#+ATTR_LATEX: :options otherkeywords={str_detect,hent_data,filter,mutate,overlevelsestavle}, deletekeywords={c,rep,print,seq,R}
#+BEGIN_SRC R :results file graphics :file ./kapitel3/K3-udvikling-ulykker.pdf :exports none :session *R* :cache yes
dax <- hent_data("doda1",årsag =c("A-19 Ulykker"),tid = 2007:2022,alder = c("15-19","20-24","25-29"))
N <- hent_data("befolk2",tid = 2007:2022,alder = c("15-19","20-24","25-29"))
N <- rename(N,R = INDHOLD)
dax <- left_join(dax,N,by = c("alder","TID"))
dax <- mutate(dax,alder = factor(alder,levels = unique(alder)),
              urate = 10000*INDHOLD/R)
dax <- rename(dax,Alder = alder)
g <- ggplot(dax,aes(TID,urate,color = Alder))+geom_line(linewidth = 1.3)+ylab("Dødsulykker per 10.000 personår")+xlab("Kalenderår")
g <- g+theme_economist()+ scale_colour_wsj("colors6") + theme(axis.text.x = element_text(angle = -45))
g <- g+theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)))
g <- g+theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)))
g+ylim(c(0,2.5))
#+END_SRC

#+RESULTS[(2024-03-18 07:03:36) c2e82622a375a95d6ee82cc8d1e54ce0495204be]:
[[file:./kapitel3/K3-udvikling-ulykker.pdf]]

#+name: fig:k3-ulykker
#+ATTR_LATEX: :width 0.9\textwidth
#+CAPTION: Udviklingen i raten af dødsulykker blandt danskere i alderen mellem 15 og 29. Kilde: statistikbankens =DOD1A= og =FOLK1A=.
[[file:./K3-udvikling-ulykker.pdf]]

** Årsagsspecifikke dødelighedstavler
:PROPERTIES:
:CUSTOM_ID: K3:aarsag
:END:

Vi konstruerer nu forskellige mål for, hvordan de specifikke
dødsårsager bidrager til den samlede dødelighed. Disse mål er
periodemål ligesom middellevetid og beregnes som udgangspunkt i en
tænkt lukket tabelbefolkning. Vi beregner restlivstidsrisiko for at dø af
en given årsag under antagelsen, at de årsagsspecifikke
mortalitetsrater er som observeret i en given kalenderperiode.

*** Årsagsspecifikke dødshyppigheder

I den ægte befolkning finder vi andelen af dødsfald, som blev
tilskrevet årsag \(Q\) i et givent aldersinterval i en given periode
og betegner den med:
#+begin_export latex
\begin{align}
{{}_kh^{Q}_x}&=\frac{{}_kD_x^Q}{_kD_x}.\intertext{Andelen af dødsfald af alle andre årsager end \(Q\) i aldersintervallet
bliver dermed}
{_kh^{\bar Q}_x} = 1-{_kh^Q_x} & = \frac{_kD_x-{}_kD_x^Q}{_kD_x}.
\end{align}
#+end_export
I en tænkt lukket tabelbefolkning kan vi nu beregne hyppigheden for at
dø af årsag \(Q\) i alderen mellem \(x\) og \(x+k-1\):
#+begin_export latex
\begin{align}
{_kq_x^Q}& = {_kq_x}\cdot {_kh^Q_x},
\intertext{og tilsvarende er hyppigheden for at dø af en anden årsag:}
{_kq_x^{\bar Q}}&= {_kq_x}\cdot(1- {_kh^Q_x}).
\end{align}
#+end_export

*** Konstruktion af en årsagsspecifik dødelighedstavle

Dekrementfunktionen, som genererer en årsagsspecifik dødelighedstavle,
tager udgangspunkt i en radix af 100.000 tabelpersoner. I hvert
alderstrin beregnes antal dødsfald ligesom i en almindelig
overlevelsestavle. Dødsårsagerne bliver opdelt i to grupper sådan, at
det samlede antal dødsfald er summen af dødsfald med årsag
\(Q\) og dødsfald med andre årsager. Det samlede antal døde i
tabelbefolkningen mellem alder \(x\) og alder \(x+k-1\) er
#+begin_export latex
\begin{align}
{_kd_x}&=\ell_x\cdot {_kq_x}.
\intertext{Det kan nu opdeles i dødsfald med årsag \(Q\)}
{_kd_x^Q}&={_kd_x}\cdot {_kh^Q_x}
\intertext{og dødsfald med andre årsager}
{_kd_x^{\bar Q}}&={_kd_x}\cdot (1-{_kh^Q_x}).
\end{align}
#+end_export
Derfor gælder i tabelbefolkningen:
#+begin_export latex
\begin{equation}
\ell_x =\underbrace{\ell_{x+k}}_{\text{i live}}+\underbrace{\ell_x\cdot {_kq_x}\cdot {_kh^Q_x}}_{\text{årsag Q}}+
\underbrace{\ell_x\cdot{_kq_x}\cdot (1-{_kh^Q_x})}_{\text{andre årsager}}.
\end{equation} 
#+end_export
Fordi der nu er to muligheder (1: dødsårsag \(Q\), 2: alle andre
dødsårsager) for at forlade tabelbefolkningen hedder funktionen
\(\ell_x\), der generer en årsagsspecifik dødelighedstavle, double
decrement function.

*** Den årsagsspecifikke restlivstidsrisiko 

Det samlede antal dødsfald med årsag \(Q\) i tabelbefolkningen, hvor
tabelpersonen er ældre end \(x\)-år, er (for 1-års intervaller) givet
som:

#+begin_export latex
\begin{align}
_{\infty}d^Q_x = &{}_1d_x^Q +{}_1d_{x+1}^Q + \cdots +{}_\infty d_{x^{max}}^Q,
\intertext{og restlivstidsrisikoen blandt $x$-årige for at dø af årsag $Q$ beregnes som}
&\operatorname{LTR}_x^Q=\frac{({}_1d_x^Q +{}_1d_{x+1}^Q + \cdots +{}_\infty d_{x^{max}}^Q)}{\ell_x}.
\end{align}
#+end_export


*** Risikoen for at dø af en bestemt årsag 

I tabelbefolkningen er det samlede antal dødsfald, hvor årsagen var
\(Q\) mellem alder 0 til alder $x$, givet ved (for 1-års intervaller):
#+begin_export latex
\begin{align}
 {{}_xd_0^Q}&={}_1d_0^Q+\cdots+{}_1d_{x-1}^Q.
\intertext{Risikoen
 for, at en nyfødt dør af årsag Q inden alder $x$, bliver}
{_xq_0^Q}&={_xd_0^Q}/\ell_0.
\intertext{Tilsvarende er risikoen for at dø på grund af andre årsager inden alder \(x\):}
{_xq_0^{\bar Q}}&={_xd_0^{\bar Q}}/\ell_0.
\intertext{Vi kan også beregne sandsynligheden for at overleve alle årsager inden alder \(x\):}
o_x = 1-{{}_xq_0}&=1-{}_xq_0^Q-{}_xq_0^{\bar Q}
\end{align}
#+end_export

** Eksempel

Vi beregner dødelighedstavlen for at dø af kræft blandt mænd i 2020 i
Danmark. Vi henter folketal fra statistikbankens register =FOLK1a= og
antal døde med kræft fra register =doda1=. Vi inddeler i 19
aldersintervaller, hvor det første interval har længde 1 år, det andet
interval har længde 4 år, resten af intervallerne har længde 5 år og
det sidste aldersinterval er fra 85 til 125 år. Vi beregner
aldersspecifikke mortalitetsrater for mænd i Danmark i 2020 og andelen af 
dødsfald med kræft.

#+ATTR_LATEX: :options otherkeywords={hent_dodsaarsag_data,filter,mutate,overlevelsestavle}, deletekeywords={c,rep,print,seq,R}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes
x <- hent_dodsaarsag_data(tid = 2020, årsag =c("A02"), køn = "Mænd")
# mortalitetsrater
x <- mutate(x,M = Dod/R)
# andel kræftdødsfald
x <- mutate(x,hQ = QDod/Dod)
x
#+END_SRC
\footnotesize
#+RESULTS[(2024-03-18 10:18:39) 85aa1798ba8a0579844152e8f9bacdf64abef5f0]:
#+begin_example
# A tibble: 19 × 9
   ÅRSAG      aldersinterval KØN     TID      R   Dod  QDod         M     hQ
   <chr>      <chr>          <chr> <dbl>  <dbl> <dbl> <dbl>     <dbl>  <dbl>
 1 A-02 Kræft 0              Mænd   2020  31512   109     0 0.00346   0     
 2 A-02 Kræft 1-4            Mænd   2020 127529    18     5 0.000141  0.278 
 3 A-02 Kræft 5-9            Mænd   2020 154685    15     3 0.0000970 0.2   
 4 A-02 Kræft 10-14          Mænd   2020 173860    18     2 0.000104  0.111 
 5 A-02 Kræft 15-19          Mænd   2020 174529    35     2 0.000201  0.0571
 6 A-02 Kræft 20-24          Mænd   2020 192608    82    11 0.000426  0.134 
 7 A-02 Kræft 25-29          Mænd   2020 204302   112     7 0.000548  0.0625
 8 A-02 Kræft 30-34          Mænd   2020 185281    88    10 0.000475  0.114 
 9 A-02 Kræft 35-39          Mænd   2020 165161   157    25 0.000951  0.159 
10 A-02 Kræft 40-44          Mænd   2020 179809   219    38 0.00122   0.174 
11 A-02 Kræft 45-49          Mænd   2020 196936   380    81 0.00193   0.213 
12 A-02 Kræft 50-54          Mænd   2020 204696   690   193 0.00337   0.280 
13 A-02 Kræft 55-59          Mænd   2020 197362  1132   385 0.00574   0.340 
14 A-02 Kræft 60-64          Mænd   2020 171437  1663   630 0.00970   0.379 
15 A-02 Kræft 65-69          Mænd   2020 155595  2556  1029 0.0164    0.403 
16 A-02 Kræft 70-74          Mænd   2020 155082  3779  1548 0.0244    0.410 
17 A-02 Kræft 75-79          Mænd   2020 115932  4584  1616 0.0395    0.353 
18 A-02 Kræft 80-84          Mænd   2020  66656  4613  1338 0.0692    0.290 
19 A-02 Kræft 85             Mænd   2020  44684  7745  1552 0.173     0.200
#+end_example

\normalsize
Med disse data beregner vi dødelighedstavlen.
\footnotesize
#+ATTR_LATEX: :options otherkeywords={dodsaarsagtavle,print,select,filter,mutate,overlevelsestavle}, deletekeywords={c,rep,print,seq,R,q,data}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes
# Chiang's \(a\) 
x <- mutate(x,a = c(0.1,2,rep(2.5,17)),k = c(1,4,rep(5,17)))
kraeftdodtavle_maend <- dodsaarsagtavle(data = x,
                                        mortalitet = "M",
                                        hQ = "hQ",
                                        alder = "aldersinterval",
                                        radix = 100000)
# fravælger kolonner som ikke er vigtige lige her
kraeftdodtavle_maend <- select(kraeftdodtavle_maend,-c(p,q,o,T))
print(kraeftdodtavle_maend,digits = 2)
#+END_SRC

#+RESULTS[(2024-03-18 10:36:22) 2e9e5ee88bb934dda0a7eb927f7c93e3387b4354]:
#+begin_example
# A tibble: 19 × 10
   Alder      l     d      dQ     hQ        qQ      L     e LTR_Q risiko_Q
   <chr>  <dbl> <dbl>   <dbl>  <dbl>     <dbl>  <dbl> <dbl> <dbl>    <dbl>
 1 0     100000   345    0    0      0          99690 79.6  0.280 0       
 2 1-4    99655    56   15.6  0.278  0.000157  398508 78.9  0.281 0.000156
 3 5-9    99599    48    9.66 0.2    0.0000969 497874 75.0  0.281 0.000253
 4 10-14  99551    52    5.72 0.111  0.0000575 497624 70.0  0.281 0.000310
 5 15-19  99499   100    5.70 0.0571 0.0000573 497246 65.0  0.281 0.000367
 6 20-24  99399   211   28.4  0.134  0.000285  496469 60.1  0.281 0.000651
 7 25-29  99188   272   17.0  0.0625 0.000171  495261 55.2  0.282 0.000820
 8 30-34  98917   235   26.7  0.114  0.000270  493996 50.4  0.282 0.00109 
 9 35-39  98682   468   74.5  0.159  0.000755  492240 45.5  0.283 0.00183 
10 40-44  98214   596  103.   0.174  0.00105   489579 40.7  0.283 0.00287 
11 45-49  97618   937  200.   0.213  0.00205   485745 35.9  0.284 0.00486 
12 50-54  96680  1616  452.   0.280  0.00467   479363 31.2  0.285 0.00938 
13 55-59  95065  2688  914.   0.340  0.00962   468603 26.7  0.285 0.0185  
14 60-64  92377  4374 1657.   0.379  0.0179    450948 22.4  0.283 0.0351  
15 65-69  88002  6943 2795.   0.403  0.0318    422655 18.4  0.278 0.0630  
16 70-74  81059  9309 3813.   0.410  0.0470    382024 14.8  0.268 0.101   
17 75-79  71750 12909 4551.   0.353  0.0634    326479 11.4  0.249 0.147   
18 80-84  58841 17358 5035.   0.290  0.0856    250812  8.33 0.227 0.197   
19 85     41484 41484 8313.   0.200  0.200     239335  5.77 0.200 0.280
#+end_example

\normalsize

Kolonnen \(\operatorname{LTR_Q}\) i aldersintervallet fra \(x\) til
\(x+k-1\) angiver restlivstidsrisikoen for at dø af kræft for en
tabelperson med alder \(x\), og \(\operatorname{risiko_Q}\) angiver
risiko for, at en tabelperson dør af kræft inden alder \(x+k\), se
Tabel ref:tab:doedelighedstavle-kolonner. Fra dødelighedstavlen kan vi
for eksempel aflæse, at sandsynligheden for, at en nyfødt dreng i 2020
dør på grund af kræft inden alder 74, er 10,1%, hvis de
årsagsspecifikke mortalitetsrater for mænd i fremtiden forbliver, som
de var i 2020. Vi ser også, at restlivstidsrisikoen for kræftdød er
27,8% for en 65-årig mænd under antagelsen, at de årsagsspecifikke
mortalitetsrater for mænd forbliver i fremtiden, som de var i 2020.

#+Label: tab:doedelighedstavle-kolonner
#+CAPTION: Forklaring af kolonner i en årsagsspecifikke dødelighedstavle produceret med R-funktionen =dodsaarsagtavle=.
#+ATTR_LATEX: :align l|p{8cm}
| Kolonne    | Betydning                                                                                                          |
|------------+--------------------------------------------------------------------------------------------------------------------|
| =Alder=    | Aldersinterval                                                                                                     |
| =l=        | Dekrementfunktion: Antal tabelpersoner i starten af intervallet                                                    |
| =d=        | Antal døde i intervallet                                                                                           |
| =dQ=       | Antal dødsfald af årsag Q i aldersintervallet.                                                                     |
| =hQ=       | Andelen af dødsfald af årsag Q i aldersintervallet                                                                 |
| =qQ=       | Dødshyppighed: sandsynlighed for at dø af årsag Q i intervallet bland tabelpersoner i live ved intervallets start  |
| =L=        | Samlet risikotid i intervallet                                                                                     |
| =e=        | Middelrestlevetid (i første interval =  middellevetid)                                                             |
| =LTR_Q=    | Restlivstidsrisikoen for at dø af kræft blandt tabelpersoner som er i live ved intervallets start                  |
| =risiko_Q= | Risiko for kræftdød inden alder ved start af intervallet                                                           |

[fn:88] https://www.rigsarkivet.dk/udforsk/doedsaarsagsregister-1943-2019/

** Header :noexport:

#+TITLE: Kapitel 3: Overlevelsestavler
#+AUTHOR: Anna-Vera Jørring Pallesen, Johan Sebastian Ohlendorff, Laust Hvas Mortensen og Thomas Alexander Gerds
#+DATE: 
#+LaTeX_CLASS: danish-article
#+OPTIONS: toc:nil
#+LaTeX_HEADER:\usepackage{authblk}
#+LaTeX_HEADER:\usepackage{natbib}
#+LaTeX_HEADER:\usepackage{listings}
#+LaTeX_HEADER:\usepackage{color}
#+LaTeX_HEADER:\usepackage[usenames,dvipsnames]{xcolor}
#+LaTeX_HEADER:\usepackage[utf8]{inputenc}
#+LaTeX_HEADER:\usepackage{hyperref}
#+LaTeX_HEADER:\usepackage{amssymb}
#+LaTeX_HEADER:\usepackage{latexsym}
#+LaTeX_HEADER:\usepackage{fancyhdr}
#+LaTeX_HEADER:\usepackage[english,danish]{babel}
#+LaTeX_HEADER:\pagestyle{fancy}
#+LaTeX_HEADER:\lhead{\tiny Folkesundhedsvidenskab 2. semester, K{\o}benhavns Universitet}
#+LaTeX_HEADER:\rhead{\tiny Demografi kompendium Kapitel 3}
#+LaTeX_HEADER:\renewcommand\theequation{K3.\arabic{equation}}
#+OPTIONS:   H:3  num:t \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:t todo:t pri:nil tags:not-in-toc author:t
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="https://publicifsv.sund.ku.dk/~tag/styles/all-purpose.css" />
#+LATEX_HEADER: \RequirePackage{tcolorbox}
#+LATEX_HEADER: \hyphenation{alders-speci-fik-ke}
#+LATEX_HEADER: \hyphenation{be-folk-ning}
#+LATEX_HEADER: \hyphenation{ta-bel-be-folk-ning}
#+LATEX_HEADER: \hyphenation{re-gist-re-ret}
#+LATEX_HEADER: \usepackage{svg}
# #+LaTeX_HEADER:\usepackage[table,usenames,dvipsnames]{xcolor}
#+LaTeX_HEADER:\definecolor{lightGray}{gray}{0.98}
#+LaTeX_HEADER:\definecolor{medioGray}{gray}{0.83}
#+LATEX_HEADER:\definecolor{mygray}{rgb}{.95, 0.95, 0.95}
#+Latex_Header: \newcommand{\qxk}{\ensuremath{{}_{k}q_{x}}}
#+Latex_Header: \newcommand{\dxk}{\ensuremath{{}_{k}d_{x}}}
#+Latex_Header: \newcommand{\qxe}[1][x]{\ensuremath{{}_{1}q_{#1}}}
#+Latex_Header: \newcommand{\Dxk}[1][x]{\ensuremath{{}_{k}D_{#1}}}
#+Latex_Header: \renewcommand{\d}[2][x]{\ensuremath{{}_{#2}d_{#1}}}
#+Latex_Header: \newcommand{\qxf}[1][x]{\ensuremath{{}_{5}q_{#1}}}
#+Latex_Header: \newcommand{\Mxf}[1][x]{\ensuremath{{}_{5}M_{#1}}}
#+Latex_Header: \newcommand{\Mxk}[1][x]{\ensuremath{{}_{k}M_{#1}}}
#+Latex_Header: \newcommand{\Rxk}[1][x]{\ensuremath{{}_{k}R_{#1}}}
#+Latex_Header: \renewcommand{\a}[2][x]{\ensuremath{{}_{#2}a_{#1}}}
#+Latex_Header: \renewcommand{\L}[2][x]{\ensuremath{{}_{#2}L_{#1}}}
#+LATEX_HEADER:\newcommand{\mybox}[1]{\vspace{.5em}\begin{tcolorbox}[boxrule=0pt,colback=mygray] #1 \end{tcolorbox}}
